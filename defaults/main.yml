---
# Copyright (C) 2018-2020 Robert Wimmer
# Copyright (C)      2020 Robin Schneider <ypid@riseup.net>
# Copyright (C)      2020 DebOps <https://debops.org/>
# SPDX-License-Identifier: GPL-3.0-or-later

#######################################
# General settings
#######################################

# Directory to store WireGuard configuration on the remote hosts
wireguard_remote_directory: '{{ ("/opt/local/etc/wireguard"
                                 if (ansible_os_family == "Darwin")
                                 else "/etc/wireguard")
                                if (wireguard__config_target == "host")
                                else (wireguard__secret_directory + "/config_" + inventory_hostname) }}'


wireguard__keys_directory: '{{ wireguard_remote_directory + "/keys" }}'

# The default port WireGuard will listen if not specified otherwise.
wireguard_port: "51820"

# The default interface name that WireGuard should use if not specified otherwise.
wireguard_interface: "wg0"

# The default owner of the wg.conf file
wireguard_conf_owner: root

# The default group of the wg.conf file
wireguard_conf_group: "{{ 'root' if not ansible_os_family == 'Darwin' else 'wheel' }}"

# The default mode of the wg.conf file
wireguard_conf_mode: 0600


#######################################
# Settings only relevant for Ubuntu
#######################################

# Set to "false" if package cache should not be updated
wireguard_ubuntu_update_cache: "true"

# Set package cache valid time
wireguard_ubuntu_cache_valid_time: "3600"

#######################################
# DebOps extensions
#######################################

# FIXME: Update docs
# Name of the WireGuard network in case it is different to the interface name.
# Might be the case if wg0 is already taken on some peers or if the network otherwise just has a more fitting name for the whole virtual network.
wireguard_inventory_group: 'wireguard_wg0'

# List of peers.
wireguard__peers: '{{ groups[wireguard_inventory_group]|d([]) | difference([inventory_hostname]) }}'

# Either "host" or "ansible_controller".
# Note that PSK is currently only supported for "ansible_controller".
wireguard__secret_authority: 'ansible_controller'

# Key templating mode. Either "inline" or "file".
wireguard__key_templating: '{{ "file" if (wireguard__config_target == "host") else "inline" }}'

# Either "host" or "ansible_controller".
wireguard__config_target: 'host'

# File path on the Ansible controller where files will be redirected to with wireguard__config_target == "ansible_controller".
# The idea behind this directory is to act as a faked / (root) directory for that "host".
wireguard__controller_host_dir_path: '{{ (inventory_dir + "../../../root-fs-by-host/" + inventory_hostname) | realpath }}'
wireguard__controller_host_owner: '{{ omit }}'
wireguard__controller_host_group: '{{ omit }}'
wireguard__controller_host_mode: '{{ omit }}'

# .. envvar:: wireguard__secret_directory [[[
#
# Secret directory to use on the Ansible controller for key management and
# generating configuration files for unmanaged peers.
wireguard__secret_directory: '{{ secret + "/wireguard/" + wireguard_inventory_group }}'

                                                                   # ]]]
# Configuration for other Ansible roles [[[
# -----------------------------------------

# .. envvar:: wireguard__etc_services__dependent_list [[[
#
# Configuration for the :ref:`debops.etc_services` Ansible role.
wireguard__etc_services__dependent_list:
  - name: 'wireguard'
    port: '{{ wireguard_port }}'
    protocols: [ 'udp' ]
    comment: 'WireGuard - fast, modern, secure kernel VPN tunnel'

                                                                   # ]]]
# .. envvar:: wireguard__ferm__dependent_rules [[[
#
# Configuration for the :ref:`debops.ferm` Ansible role.
wireguard__ferm__dependent_rules:

  - type: 'accept'
    protocol: 'udp'
    dport: '{{ wireguard_port }}'
    accept_any: True
    weight: '40'
    name: 'wireguard'
                                                                   # ]]]
                                                                   # ]]]
